name: CI/CD Pipeline

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          lfs: true

      - name: Build Docker Image
        run: |
          docker build -t brain-api .

      - name: Run Docker Container
        run: |
          docker run -d -p 8000:7860 --name test-container brain-api
          sleep 15

      - name: Install Test Dependencies
        run: |
          pip install requests pillow

      - name: Run API Test
        run: |
          python test_api.py

      - name: Push to Hugging Face Hub
        if: success()
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          pip install huggingface_hub
          
          python << 'EOF'
          import os
          from huggingface_hub import HfApi, login
          
          token = os.environ['HF_TOKEN']
          login(token=token)
          
          api = HfApi()
          repo_id = "abdoghazala7/brain-tumor-classification-api"
          repo_type = "space"
          
          print("Starting deployment to Hugging Face Space...")
          
          files_to_upload = [
              ".dockerignore",
              "Dockerfile",
              "README.md",
              "config.py",
              "efficientnet_finetuned_final.pth",
              "gunicorn_config.py",
              "image_utils.py",
              "main.py",
              "model_loader.py",
              "predictor.py",
              "requirements.txt"
          ]
          
          for file_path in files_to_upload:
              try:
                  print(f"Uploading: {file_path}")
                  api.upload_file(
                      path_or_fileobj=file_path,
                      path_in_repo=file_path,
                      repo_id=repo_id,
                      repo_type=repo_type,
                      commit_message="Deploy from GitHub Actions"
                  )
                  print(f"Successfully uploaded: {file_path}")
              except Exception as e:
                  print(f"Error uploading {file_path}: {e}")
                  raise
          
          print("Deployment completed successfully!")
          EOF

      - name: Verify Deployment Status
        if: success()
        run: |
          python -c "
          import time
          import sys
          from huggingface_hub import HfApi
          
          api = HfApi()
          repo_id = 'abdoghazala7/brain-tumor-classification-api'
          
          print('Waiting for Space to build...')
          start_time = time.time()
          timeout = 600
          
          while True:
              elapsed = time.time() - start_time
              if elapsed > timeout:
                  print('Timeout reached after 10 minutes.')
                  sys.exit(1)
              
              try:
                  status = api.get_space_runtime(repo_id=repo_id).stage
                  print(f'Status: {status} (Elapsed: {int(elapsed)}s)')
                  
                  if status == 'RUNNING':
                      print('Space is running successfully!')
                      sys.exit(0)
                  
                  if status in ['BUILD_ERROR', 'RUNTIME_ERROR']:
                      print(f'Space failed with status: {status}')
                      sys.exit(1)
                      
              except Exception as e:
                  print(f'Checking status... ({int(elapsed)}s)')
              
              time.sleep(10)
          "