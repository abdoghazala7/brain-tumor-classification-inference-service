name: CI/CD Pipeline

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          lfs: true

      - name: Build Docker Image
        run: |
          docker build -t brain-api .

      - name: Run Docker Container
        run: |
          docker run -d -p 8000:7860 --name test-container brain-api
          sleep 15

      - name: Install Test Dependencies
        run: |
          pip install requests pillow

      - name: Run API Test
        run: |
          python test_api.py

      - name: Prepare README for Hugging Face
        run: |
          cat > README_HF.md << 'EOFREADME'
          ---
          title: Brain Tumor Classification API
          emoji: ðŸ§ 
          colorFrom: blue
          colorTo: purple
          sdk: docker
          pinned: false
          ---
          
          EOFREADME
          cat README.md >> README_HF.md

      - name: Push to Hugging Face Hub
        if: success()
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          pip install huggingface_hub
          
          python << 'EOF'
          import os
          from huggingface_hub import HfApi, login
          
          token = os.environ['HF_TOKEN']
          login(token=token)
          
          api = HfApi()
          repo_id = "abdoghazala7/brain-tumor-classification-api"
          repo_type = "space"
          
          print("Starting deployment to Hugging Face Space...")
          
          files_to_upload = [
              (".dockerignore", ".dockerignore"),
              ("Dockerfile", "Dockerfile"),
              ("README_HF.md", "README.md"),
              ("config.py", "config.py"),
              ("efficientnet_finetuned_final.pth", "efficientnet_finetuned_final.pth"),
              ("gunicorn_config.py", "gunicorn_config.py"),
              ("image_utils.py", "image_utils.py"),
              ("main.py", "main.py"),
              ("model_loader.py", "model_loader.py"),
              ("predictor.py", "predictor.py"),
              ("requirements.txt", "requirements.txt")
          ]
          
          for local_path, repo_path in files_to_upload:
              try:
                  print(f"Uploading: {local_path} -> {repo_path}")
                  api.upload_file(
                      path_or_fileobj=local_path,
                      path_in_repo=repo_path,
                      repo_id=repo_id,
                      repo_type=repo_type,
                      commit_message="Deploy from GitHub Actions"
                  )
                  print(f"Successfully uploaded: {repo_path}")
              except Exception as e:
                  print(f"Error uploading {local_path}: {e}")
                  raise
          
          print("Deployment completed successfully!")
          EOF

      - name: Verify Deployment Status
        if: success()
        run: |
          python -c "
          import time
          import sys
          from huggingface_hub import HfApi
          
          api = HfApi()
          repo_id = 'abdoghazala7/brain-tumor-classification-api'
          
          print('Waiting for Space to build...')
          start_time = time.time()
          timeout = 600
          
          while True:
              elapsed = time.time() - start_time
              if elapsed > timeout:
                  print('Timeout reached after 10 minutes.')
                  sys.exit(1)
              
              try:
                  status = api.get_space_runtime(repo_id=repo_id).stage
                  print(f'Status: {status} (Elapsed: {int(elapsed)}s)')
                  
                  if status == 'RUNNING':
                      print('Space is running successfully!')
                      sys.exit(0)
                  
                  if status in ['BUILD_ERROR', 'RUNTIME_ERROR']:
                      print(f'Space failed with status: {status}')
                      sys.exit(1)
                      
              except Exception as e:
                  print(f'Checking status... ({int(elapsed)}s)')
              
              time.sleep(10)
          "